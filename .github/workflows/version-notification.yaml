name: Discord Tag Notification

on:
  push:
    tags:
      - '*'

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get tag details
        id: tag-details
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          TAG_MESSAGE=$(git tag -l --format='%(contents)' $TAG_NAME | tr -d '"' | tr '\n' ' ')
          TAG_AUTHOR=$(git for-each-ref --format='%(taggername)' refs/tags/$TAG_NAME || git for-each-ref --format='%(committername)' refs/tags/$TAG_NAME)
          TAG_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"
          COMMIT_SHA=$(git rev-list -n 1 $TAG_NAME)

          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS_MESSAGES=$(git log --pretty=format:"• %s" $PREVIOUS_TAG..$TAG_NAME | tr '\n' ' ' | tr -d '"')
          else
            COMMITS_MESSAGES=$(git log --pretty=format:"• %s" $TAG_NAME | tr '\n' ' ' | tr -d '"')
          fi

          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          if [ -n "$TAG_MESSAGE" ]; then
            echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
            echo "**Commits inclus:**\\n" >> $GITHUB_OUTPUT
            echo "$COMMITS_MESSAGES" >> $GITHUB_OUTPUT
          else
            echo "**Commits inclus:**\\n" >> $GITHUB_OUTPUT
            echo "$COMMITS_MESSAGES" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$TAG_AUTHOR" >> $GITHUB_OUTPUT
          echo "url=$TAG_URL" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          if [ -n "$PREVIOUS_TAG" ]; then
            COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..$TAG_NAME)
          else
            COMMIT_COUNT=$(git rev-list --count $TAG_NAME)
          fi
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        env:
          MESSAGE: ${{ steps.tag-details.outputs.message }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          PREVIOUS_TAG_DISPLAY=${{ steps.tag-details.outputs.previous_tag }}
          if [ -z "$PREVIOUS_TAG_DISPLAY" ]; then
            PREVIOUS_TAG_DISPLAY="le début"
          fi

          # Nettoyer et formater correctement le message
          MESSAGE_ESCAPED=$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # Tronquer le champ Notes de version si nécessaire
          if [ ${#MESSAGE_ESCAPED} -gt 1024 ]; then
            MESSAGE_ESCAPED="${MESSAGE_ESCAPED:0:1020}..."
          fi

          echo '{}' | jq \
            --arg username "GitHub" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg title "🏷️ Nouvelle version: ${{ steps.tag-details.outputs.name }}" \
            --arg url "${{ steps.tag-details.outputs.url }}" \
            --arg color "5814783" \
            --arg tag "\`${{ steps.tag-details.outputs.name }}\`" \
            --arg commits "${{ steps.tag-details.outputs.commit_count }} depuis $PREVIOUS_TAG_DISPLAY" \
            --arg notes "$MESSAGE_ESCAPED" \
            --arg author "${{ github.event.repository.name }}" \
            --arg footer "Publié par ${{ steps.tag-details.outputs.author }}" \
            --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '.username = $username |
             .avatar_url = $avatar_url |
             .embeds = [{
               "title": $title,
               "url": $url,
               "color": ($color | tonumber),
               "fields": [
                 {"name": "Tag", "value": $tag, "inline": true},
                 {"name": "Commits", "value": $commits, "inline": true},
                 {"name": "Notes de version", "value": $notes | gsub("\\\\n"; "\n")}
               ],
               "author": {"name": $author},
               "footer": {"text": $footer},
               "timestamp": $timestamp
             }]' > payload.json

          cat payload.json

          curl -H "Content-Type: application/json" -X POST $DISCORD_WEBHOOK -d @payload.json
